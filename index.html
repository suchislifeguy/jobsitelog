<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#0f172a" />
    <meta name="description" content="Professional JobSite Log & Estimate Creator" />
    
    <!-- Favicon -->
    <link rel="icon" href="https://cdn.jsdelivr.net/npm/lucide-static@0.344.0/icons/hammer.svg" type="image/svg+xml">

    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="JobSite Log" />

    <!-- Android/PWA Support -->
    <link rel="manifest" href="./manifest.json" />

    <title>JobSite Log | Estimator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f1f5f9;
        overscroll-behavior-y: none;
      }
      /* Hide scrollbar for clean UI */
      .custom-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .custom-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>

    <!-- Import Map: Using strictly React 18 to prevent version conflicts -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.344.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
  </head>
  <body>
    <div id="root"></div>

    <!-- MAIN APP CODE (INLINED) -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef, useMemo } from 'react';
      import ReactDOM from 'react-dom/client';
      import { 
        Clock, Trash2, Package, Wrench, ImageIcon, 
        Download, Printer, FileText, 
        Plus, X, Save, Hammer, Clipboard, ArrowLeft, MapPin, HardHat, AlertTriangle, 
        Calendar, ChevronRight, ClipboardList 
      } from 'lucide-react';

      // --- COMPONENTS ---

      // 1. TaskCard
      const TaskCard = ({ task, index, onDelete }) => {
        const images = task.imageUrls || [];

        const handleDelete = (e) => {
          e.stopPropagation();
          onDelete(task.id);
        };

        return (
          <div className="group bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden transition-all duration-200 print:shadow-none print:border-2 print:border-gray-800 print:rounded-none print:break-inside-avoid hover:border-orange-300 hover:shadow-md">
            
            {images.length > 0 && (
              <div className={`w-full bg-slate-100 border-b border-slate-100 relative overflow-hidden print:border-b-2 print:border-gray-800 ${images.length > 1 ? 'grid grid-cols-2 gap-0.5 print:gap-1' : ''}`}>
                  {images.map((url, idx) => (
                    <div 
                      key={idx} 
                      className={`relative ${
                        images.length === 1 ? 'h-56 w-full print:h-64' : 
                        images.length === 2 ? 'h-48 w-full print:h-48' : 
                        images.length === 3 && idx === 0 ? 'h-48 col-span-2 print:h-48' : 
                        'h-32 w-full print:h-40'
                      }`}
                    >
                      <img 
                        src={url} 
                        alt={`Photo ${idx + 1}`} 
                        className="w-full h-full object-cover"
                      />
                    </div>
                  ))}
              </div>
            )}

            <div className="p-5 print:p-6">
              <div className="flex items-start justify-between mb-3 gap-3">
                <div className="flex items-start gap-3 flex-1">
                  <div className="mt-1 flex-shrink-0 h-8 w-8 rounded-lg bg-slate-900 text-white flex items-center justify-center font-bold text-sm print:border-2 print:border-black print:bg-transparent print:text-black">
                    #{index + 1}
                  </div>

                  <div className="flex-1 min-w-0">
                    <h3 className="font-bold text-lg leading-tight truncate print:whitespace-normal print:overflow-visible print:text-xl text-slate-900 print:text-black">
                      {task.title}
                    </h3>
                    <div className="flex items-center gap-2 text-sm text-slate-500 mt-1 print:text-black print:font-medium">
                      {task.estimatedTime && (
                        <div className="flex items-center gap-1 bg-slate-100 px-2 py-0.5 rounded text-xs font-medium print:bg-transparent print:p-0 print:text-sm">
                          <Clock size={12} className="print:hidden" />
                          <span className="print:hidden">Est:</span>
                          <span>{task.estimatedTime}</span>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
                <button 
                  onClick={handleDelete}
                  className="text-white bg-red-500 p-2 rounded-lg transition-colors print:hidden hover:bg-red-600 shadow-sm"
                  title="Delete Item"
                >
                  <Trash2 size={20} />
                </button>
              </div>

              {task.description && (
                <p className="text-slate-600 text-sm mb-4 whitespace-pre-wrap print:text-black print:text-base print:mb-2">
                  {task.description}
                </p>
              )}

              {(task.materials.length > 0 || task.tools.length > 0) && (
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-3 border-t border-slate-100 print:border-t-2 print:border-gray-200 print:grid-cols-2 print:gap-8 print:pt-4">
                  {task.materials.length > 0 && (
                    <div>
                      <div className="flex items-center gap-1.5 mb-1.5 text-xs font-bold text-slate-500 uppercase tracking-wider print:text-black print:text-xs print:mb-2">
                        <Package size={12} className="print:hidden" />
                        <span>Materials</span>
                      </div>
                      <ul className="list-disc list-inside text-sm text-slate-700 leading-relaxed print:text-black print:list-disc">
                        {task.materials.map((item, idx) => (
                          <li key={idx} className="truncate print:whitespace-normal print:overflow-visible marker:text-orange-300 print:marker:text-black">{item}</li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {task.tools.length > 0 && (
                    <div>
                      <div className="flex items-center gap-1.5 mb-1.5 text-xs font-bold text-slate-500 uppercase tracking-wider print:text-black print:text-xs print:mb-2">
                        <Wrench size={12} className="print:hidden" />
                        <span>Tools</span>
                      </div>
                      <ul className="list-disc list-inside text-sm text-slate-700 leading-relaxed print:text-black print:list-disc">
                        {task.tools.map((item, idx) => (
                          <li key={idx} className="truncate print:whitespace-normal print:overflow-visible marker:text-blue-300 print:marker:text-black">{item}</li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>
              )}

              {images.length === 0 && !task.description && task.materials.length === 0 && task.tools.length === 0 && (
                 <div className="flex flex-col items-center justify-center py-4 text-slate-300 print:hidden">
                    <ImageIcon size={24} className="mb-1 opacity-50" />
                    <span className="text-xs">No details added</span>
                 </div>
              )}
            </div>
          </div>
        );
      };

      // 2. JobProjectCard
      const JobProjectCard = ({ job, onClick, onDelete }) => {
        const totalTasks = job.tasks.length;

        return (
          <div 
            onClick={() => onClick(job.id)}
            className="group bg-white rounded-xl shadow-sm border border-slate-200 hover:border-orange-400 hover:shadow-md transition-all duration-200 cursor-pointer relative overflow-hidden"
          >
            <div className="p-6">
              <div className="flex justify-between items-start mb-4">
                <div className="flex items-start gap-3">
                  <div className="bg-slate-100 p-3 rounded-lg group-hover:bg-orange-50 transition-colors">
                    <MapPin className="text-slate-600 group-hover:text-orange-600" size={24} />
                  </div>
                  <div>
                    <h3 className="font-bold text-lg text-slate-900 leading-tight group-hover:text-orange-600 transition-colors">
                      {job.address}
                    </h3>
                    {job.clientName && (
                      <p className="text-sm text-slate-500">{job.clientName}</p>
                    )}
                    <div className="flex items-center gap-2 mt-2 text-xs text-slate-400">
                      <Calendar size={12} />
                      <span>{new Date(job.updatedAt).toLocaleDateString()}</span>
                    </div>
                  </div>
                </div>
                
                <button 
                  onClick={(e) => onDelete(job.id, e)}
                  className="text-slate-400 hover:text-red-600 p-2 hover:bg-red-50 rounded-full transition-colors"
                  title="Delete Job"
                >
                  <Trash2 size={20} />
                </button>
              </div>

              <div className="flex items-center gap-2 text-slate-500 bg-slate-50 px-3 py-2 rounded-md w-fit">
                <ClipboardList size={16} />
                <span className="font-medium text-sm">{totalTasks} {totalTasks === 1 ? 'Item' : 'Items'} Recorded</span>
              </div>
            </div>

            <div className="bg-slate-50 px-6 py-3 border-t border-slate-100 flex justify-between items-center text-sm font-medium text-slate-600 group-hover:text-slate-900 group-hover:bg-orange-50/30 transition-colors">
              <span>Open Job Details</span>
              <ChevronRight size={16} />
            </div>
          </div>
        );
      };

      // 3. SummarySidebar
      const SummarySidebar = ({ tasks, jobAddress, clientName }) => {
        
        const allMaterials = useMemo(() => {
          const mats = [];
          tasks.forEach(t => t.materials.forEach(m => mats.push(m)));
          return mats.sort();
        }, [tasks]);

        const allTools = useMemo(() => {
          const tools = new Set();
          tasks.forEach(t => t.tools.forEach(too => tools.add(too)));
          return Array.from(tools).sort();
        }, [tasks]);

        const totalEstimatedTime = useMemo(() => {
          let totalMinutes = 0;
          tasks.forEach(t => {
            if (!t.estimatedTime) return;
            const timeStr = t.estimatedTime.toLowerCase().trim();
            let minutes = 0;
            const hoursMatch = timeStr.match(/(\d+(\.\d+)?)\s*(h|hr|hour)/);
            const minsMatch = timeStr.match(/(\d+)\s*(m|min)/);

            if (hoursMatch) minutes += parseFloat(hoursMatch[1]) * 60;
            if (minsMatch) minutes += parseInt(minsMatch[1], 10);
            if (!hoursMatch && !minsMatch) {
              const val = parseFloat(timeStr);
              if (!isNaN(val)) minutes += val * 60;
            }
            totalMinutes += minutes;
          });
          return totalMinutes;
        }, [tasks]);

        const formatTime = (minutes) => {
          if (minutes === 0) return "0h";
          const h = Math.floor(minutes / 60);
          const m = Math.round(minutes % 60);
          if (h > 0 && m > 0) return `${h}h ${m}m`;
          if (h > 0) return `${h}h`;
          return `${m}m`;
        };

        const handleDownloadFullLog = () => {
          if (tasks.length === 0) return;
          let content = `JOBSITE ESTIMATE\nJob: ${jobAddress}\n`;
          if (clientName) content += `Client: ${clientName}\n`;
          content += `Date: ${new Date().toLocaleDateString()}\nTotal Items: ${tasks.length}\nTotal Est. Time: ${formatTime(totalEstimatedTime)}\n==================================================\n\n`;
          
          tasks.forEach((task, index) => {
            content += `ENTRY #${index + 1}: ${task.title.toUpperCase()}\n`;
            if (task.estimatedTime) content += `Time Est: ${task.estimatedTime}\n`;
            content += `--------------------------------------------------\n`;
            if (task.description) content += `NOTES:\n${task.description}\n\n`;
            if (task.materials.length > 0) {
              content += `MATERIALS:\n`;
              task.materials.forEach(m => content += ` - ${m}\n`);
              content += `\n`;
            }
            if (task.tools.length > 0) {
              content += `TOOLS:\n`;
              task.tools.forEach(t => content += ` - ${t}\n`);
              content += `\n`;
            }
            if (task.imageUrls.length > 0) content += `[Attached ${task.imageUrls.length} photo(s) to this item]\n`;
            content += "\n==================================================\n\n";
          });

          content += " MATERIAL LIST:\n";
          allMaterials.forEach(m => content += `[ ] ${m}\n`);
          content += "\nREQUIRED TOOLS:\n";
          allTools.forEach(t => content += `[ ] ${t}\n`);

          const blob = new Blob([content], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Estimate_${jobAddress.replace(/[^a-z0-9]/gi, '_')}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        };

        const handlePrint = () => {
          window.print();
        };

        if (tasks.length === 0) return null;

        return (
          <div className="bg-white rounded-xl border border-slate-200 shadow-sm p-6 sticky top-6 print:hidden">
            <h2 className="text-lg font-bold mb-6 flex items-center gap-2 text-slate-800 border-b border-slate-100 pb-3">
              <FileText className="text-orange-600" size={20} /> 
              Job Summary
            </h2>

            <div className="space-y-3">
              <button onClick={handlePrint} className="w-full py-3 px-4 bg-slate-900 text-white text-sm font-bold rounded-lg hover:bg-slate-800 transition-colors flex items-center justify-center gap-2 shadow-sm">
                <Printer size={18} /> Print / Save as PDF
              </button>
              <button onClick={handleDownloadFullLog} className="w-full py-3 px-4 bg-white text-slate-700 text-sm font-medium rounded-lg hover:bg-slate-50 transition-colors flex items-center justify-center gap-2 border border-slate-200">
                <Download size={18} /> Download Text Quote
              </button>
            </div>

            <div className="mt-8 pt-6 border-t border-slate-100 space-y-6">
              <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Job Totals</h3>
              <div className="flex items-center justify-between bg-slate-50 p-3 rounded-lg border border-slate-100">
                <div className="flex items-center gap-2 text-sm font-semibold text-slate-700">
                   <Clock size={16} className="text-orange-500" />
                   <span>Total Est. Time</span>
                </div>
                <span className="font-bold text-slate-900">{formatTime(totalEstimatedTime)}</span>
              </div>
              <div>
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2 text-sm font-semibold text-slate-700">
                     <Package size={16} className="text-slate-400" />
                     <span>Material List</span>
                  </div>
                  <span className="text-xs text-slate-400 font-medium">{allMaterials.length} items</span>
                </div>
                {allMaterials.length > 0 ? (
                  <ul className="space-y-1 max-h-60 overflow-y-auto pr-1 custom-scrollbar">
                    {allMaterials.map((m, i) => (
                      <li key={i} className="text-xs text-slate-600 flex items-start gap-2">
                        <span className="mt-1 w-1.5 h-1.5 rounded-full bg-orange-400 flex-shrink-0"></span>
                        <span className="leading-tight">{m}</span>
                      </li>
                    ))}
                  </ul>
                ) : <p className="text-xs text-slate-400 italic">None recorded.</p>}
              </div>
              <div>
                <div className="flex items-center gap-2 text-sm font-semibold text-slate-700 mb-2">
                   <Wrench size={16} className="text-slate-400" />
                   <span>Tools Needed</span>
                </div>
                {allTools.length > 0 ? (
                  <div className="flex flex-wrap gap-1">
                    {allTools.map((t, i) => (
                      <span key={i} className="inline-flex items-center px-2 py-1 rounded-md bg-blue-50 text-blue-700 text-xs font-medium border border-blue-100">{t}</span>
                    ))}
                  </div>
                ) : <p className="text-xs text-slate-400 italic">None recorded.</p>}
              </div>
            </div>
          </div>
        );
      };

      // --- MAIN APP COMPONENT ---
      const App = () => {
        const [jobs, setJobs] = useState([]);
        const [activeJobId, setActiveJobId] = useState(null);
        const [viewMode, setViewMode] = useState('dashboard');
        const [storageError, setStorageError] = useState(null);
        
        // Task Form
        const [isTaskFormOpen, setIsTaskFormOpen] = useState(false);
        const [taskTitle, setTaskTitle] = useState('');
        const [taskTime, setTaskTime] = useState('');
        const [taskMaterials, setTaskMaterials] = useState('');
        const [taskTools, setTaskTools] = useState('');
        const [taskDescription, setTaskDescription] = useState('');
        const [imagePreviews, setImagePreviews] = useState([]);
        const [isProcessingImages, setIsProcessingImages] = useState(false);
        const fileInputRef = useRef(null);

        // Job Form
        const [isJobFormOpen, setIsJobFormOpen] = useState(false);
        const [newJobAddress, setNewJobAddress] = useState('');
        const [newJobClient, setNewJobClient] = useState('');

        // Init Load
        useEffect(() => {
          const savedJobs = localStorage.getItem('jobsite-log-jobs');
          if (savedJobs) {
            try {
              const parsedJobs = JSON.parse(savedJobs);
              const migratedJobs = parsedJobs.map(job => ({
                ...job,
                tasks: job.tasks.map(task => ({
                  ...task,
                  imageUrls: task.imageUrls || (task.imageUrl ? [task.imageUrl] : [])
                }))
              }));
              setJobs(migratedJobs);
            } catch (e) {
              setJobs([]);
            }
          }
        }, []);

        // Save on Change
        useEffect(() => {
          try {
            localStorage.setItem('jobsite-log-jobs', JSON.stringify(jobs));
            setStorageError(null);
          } catch (e) {
            setStorageError("Storage full! Delete some photos or old jobs.");
          }
        }, [jobs]);

        const openJob = (id) => {
          setActiveJobId(id);
          setViewMode('job-detail');
          setIsTaskFormOpen(false);
          window.scrollTo(0, 0);
        };

        const goToDashboard = () => {
          setActiveJobId(null);
          setViewMode('dashboard');
          setIsTaskFormOpen(false);
        };

        const handleAddJob = (e) => {
          e.preventDefault();
          if (!newJobAddress.trim()) return;
          const newJob = {
            id: crypto.randomUUID(),
            address: newJobAddress,
            clientName: newJobClient,
            tasks: [],
            createdAt: Date.now(),
            updatedAt: Date.now(),
          };
          setJobs(prev => [newJob, ...prev]);
          setNewJobAddress('');
          setNewJobClient('');
          setIsJobFormOpen(false);
        };

        const deleteJob = (id, e) => {
          e.stopPropagation();
          if (window.confirm('Delete this entire job and all its tasks?')) {
            setJobs(prev => prev.filter(j => j.id !== id));
          }
        };

        const compressImage = (file) => {
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
              const img = new Image();
              img.src = event.target.result;
              img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_SIZE = 1024;
                let width = img.width;
                let height = img.height;
                if (width > height) {
                  if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                } else {
                  if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                if (ctx) {
                  ctx.drawImage(img, 0, 0, width, height);
                  resolve(canvas.toDataURL('image/jpeg', 0.7));
                } else {
                  resolve(event.target.result);
                }
              };
              img.onerror = () => resolve(event.target.result);
            };
          });
        };

        const handleImageUpload = async (e) => {
          const files = e.target.files;
          if (files && files.length > 0) {
            setIsProcessingImages(true);
            const processedImages = [];
            try {
              for (let i = 0; i < files.length; i++) {
                const base64 = await compressImage(files[i]);
                processedImages.push(base64);
              }
              setImagePreviews(prev => [...prev, ...processedImages]);
            } catch (err) {
              alert("Could not process images.");
            } finally {
              setIsProcessingImages(false);
            }
          }
        };

        const removeImagePreview = (index) => {
          setImagePreviews(prev => prev.filter((_, i) => i !== index));
        };

        const resetTaskForm = () => {
          setTaskTitle('');
          setTaskTime('');
          setTaskMaterials('');
          setTaskTools('');
          setTaskDescription('');
          setImagePreviews([]);
          setIsTaskFormOpen(false);
          if (fileInputRef.current) fileInputRef.current.value = '';
        };

        const handleAddTask = (e) => {
          e.preventDefault();
          if (!taskTitle.trim() || !activeJobId) return;
          const newTask = {
            id: crypto.randomUUID(),
            title: taskTitle,
            estimatedTime: taskTime,
            description: taskDescription,
            materials: taskMaterials.split(',').map(s => s.trim()).filter(Boolean),
            tools: taskTools.split(',').map(s => s.trim()).filter(Boolean),
            imageUrls: imagePreviews,
            isCompleted: false,
            createdAt: Date.now(),
          };
          setJobs(prev => prev.map(job => {
            if (job.id === activeJobId) {
              return { ...job, tasks: [newTask, ...job.tasks], updatedAt: Date.now() };
            }
            return job;
          }));
          resetTaskForm();
        };

        const deleteTask = (taskId) => {
          if (window.confirm('Delete this entry?')) {
            setJobs(prev => prev.map(job => {
              if (job.id === activeJobId) {
                return { ...job, tasks: job.tasks.filter(t => t.id !== taskId), updatedAt: Date.now() };
              }
              return job;
            }));
          }
        };

        const activeJob = jobs.find(j => j.id === activeJobId);

        return (
          <div className="min-h-screen bg-slate-50 text-slate-900 pb-20 font-sans print:bg-white print:pb-0 print:h-auto print:overflow-visible">
            {storageError && (
              <div className="bg-red-600 text-white p-2 text-center text-sm font-bold print:hidden sticky top-0 z-50">
                <div className="flex items-center justify-center gap-2"><AlertTriangle size={16} />{storageError}</div>
              </div>
            )}

            <header className="bg-slate-900 text-white shadow-md sticky top-0 z-20 print:hidden">
              <div className="max-w-5xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  {viewMode === 'job-detail' ? (
                     <button onClick={goToDashboard} className="p-2 -ml-2 rounded-full hover:bg-slate-800 transition-colors flex items-center gap-2">
                       <ArrowLeft size={20} /><span className="text-sm font-semibold text-slate-300">Back to Jobs</span>
                     </button>
                  ) : (
                    <div className="flex items-center gap-3">
                      <div className="bg-orange-600 p-1.5 rounded-lg"><Hammer className="text-white h-5 w-5" /></div>
                      <div><h1 className="text-xl font-bold tracking-tight">JobSite Log</h1></div>
                    </div>
                  )}
                </div>

                {viewMode === 'dashboard' ? (
                  jobs.length > 0 && (
                    <button onClick={() => setIsJobFormOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-orange-600 hover:bg-orange-500 text-white rounded-full font-medium transition-all shadow-lg hover:shadow-orange-500/30 text-sm">
                      <Plus size={18} /><span className="hidden sm:inline">New Job</span>
                    </button>
                  )
                ) : (
                  <div className="flex items-center gap-2">
                     <button onClick={() => window.print()} className="flex items-center gap-2 px-3 py-2 bg-slate-800 hover:bg-slate-700 text-slate-200 rounded-full font-medium transition-all text-sm mr-2" title="Print/PDF">
                       <Printer size={18} /><span className="hidden sm:inline">Print / PDF</span>
                     </button>
                     <button onClick={() => setIsTaskFormOpen(!isTaskFormOpen)} className={`flex items-center gap-2 px-4 py-2 rounded-full font-medium transition-all text-sm ${isTaskFormOpen ? 'bg-slate-700 text-white' : 'bg-orange-600 text-white hover:bg-orange-500 shadow-lg'}`}>
                      {isTaskFormOpen ? <X size={18} /> : <Plus size={18} />}<span className="hidden sm:inline">{isTaskFormOpen ? 'Cancel' : 'Add Item'}</span>
                    </button>
                  </div>
                )}
              </div>
              {viewMode === 'job-detail' && activeJob && (
                <div className="border-t border-slate-800 bg-slate-900 pb-4 pt-1 px-4">
                   <div className="max-w-5xl mx-auto">
                      <h2 className="text-2xl font-bold text-white flex items-center gap-2"><MapPin className="text-orange-500" size={24} />{activeJob.address}</h2>
                      {activeJob.clientName && <p className="text-slate-400 text-sm ml-8">{activeJob.clientName}</p>}
                   </div>
                </div>
              )}
            </header>

            <div className="hidden print:block border-b-2 border-black pb-6 mb-8 pt-8 px-8">
               <div className="flex justify-between items-start">
                 <div>
                   <h1 className="text-4xl font-bold text-black">{activeJob?.address}</h1>
                   {activeJob?.clientName && <p className="text-xl text-gray-600 mt-2">Client: {activeJob.clientName}</p>}
                 </div>
                 <div className="text-right">
                   <div className="flex items-center justify-end gap-2 text-black font-bold text-xl mb-1"><Hammer size={24} /> JobSite Estimate</div>
                   <p className="text-sm text-gray-500">Generated on {new Date().toLocaleDateString()}</p>
                   <p className="text-sm text-gray-500 mt-1">{activeJob?.tasks.length} Items</p>
                 </div>
               </div>
            </div>

            <main className="max-w-5xl mx-auto px-4 sm:px-6 py-8 print:px-8 print:py-0 print:max-w-full">
              {viewMode === 'dashboard' && (
                <>
                  {isJobFormOpen && (
                     <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 print:hidden">
                       <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in-95 duration-200">
                          <div className="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                            <h3 className="font-bold text-lg">Add New Job</h3>
                            <button onClick={() => setIsJobFormOpen(false)} className="text-slate-400 hover:text-slate-600"><X size={20} /></button>
                          </div>
                          <form onSubmit={handleAddJob} className="p-6 space-y-4">
                            <div>
                              <label className="block text-sm font-medium text-slate-700 mb-1">Job Address / Name *</label>
                              <input autoFocus required type="text" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" placeholder="e.g. 42 Wallaby Way" value={newJobAddress} onChange={e => setNewJobAddress(e.target.value)} />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-slate-700 mb-1">Client Name (Optional)</label>
                              <input type="text" className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" placeholder="e.g. P. Sherman" value={newJobClient} onChange={e => setNewJobClient(e.target.value)} />
                            </div>
                            <div className="pt-2"><button type="submit" className="w-full bg-slate-900 text-white font-bold py-3 rounded-lg hover:bg-slate-800 transition-colors">Create Job</button></div>
                          </form>
                       </div>
                     </div>
                  )}

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6 print:hidden">
                    {jobs.length === 0 ? (
                      <div className="md:col-span-2 text-center py-24 bg-white rounded-xl border-2 border-dashed border-slate-200">
                        <div className="inline-flex items-center justify-center w-20 h-20 bg-slate-50 rounded-full mb-4"><HardHat className="text-slate-300" size={40} /></div>
                        <h3 className="text-xl font-bold text-slate-700">No Jobs Recorded</h3>
                        <p className="text-slate-400 mt-2 mb-6">Create a job to start logging items.</p>
                        <button onClick={() => setIsJobFormOpen(true)} className="inline-flex items-center gap-2 px-6 py-3 bg-orange-600 hover:bg-orange-500 text-white rounded-lg font-bold transition-all shadow-lg"><Plus size={18} /> Create First Job</button>
                      </div>
                    ) : (
                      jobs.map(job => <JobProjectCard key={job.id} job={job} onClick={openJob} onDelete={deleteJob} />)
                    )}
                  </div>
                </>
              )}

              {viewMode === 'job-detail' && activeJob && (
                <>
                  {isTaskFormOpen && (
                    <div className="mb-8 bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden animate-in fade-in slide-in-from-top-4 duration-200 print:hidden">
                      <div className="bg-slate-100 px-6 py-3 border-b border-slate-200 flex items-center justify-between">
                        <h2 className="font-bold text-slate-700 flex items-center gap-2"><Clipboard size={18} />Record New Item for {activeJob.address}</h2>
                      </div>
                      <form onSubmit={handleAddTask} className="p-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <div className="space-y-4">
                            <div><label className="block text-sm font-semibold text-slate-700 mb-1">Item Title *</label><input type="text" required placeholder="e.g. Paint Living Room" className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" value={taskTitle} onChange={(e) => setTaskTitle(e.target.value)} /></div>
                            <div><label className="block text-sm font-semibold text-slate-700 mb-1">Est. Time</label><input type="text" placeholder="e.g. 2 hours, 30 mins" className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" value={taskTime} onChange={(e) => setTaskTime(e.target.value)} /></div>
                            <div><label className="block text-sm font-semibold text-slate-700 mb-1">Notes</label><textarea rows={3} placeholder="Describe the work..." className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none resize-none" value={taskDescription} onChange={(e) => setTaskDescription(e.target.value)} /></div>
                          </div>
                          <div className="space-y-4">
                            <div><label className="block text-sm font-semibold text-slate-700 mb-1">Materials (comma separated)</label><input type="text" placeholder="Paint, Tape, Primer" className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" value={taskMaterials} onChange={(e) => setTaskMaterials(e.target.value)} /></div>
                            <div><label className="block text-sm font-semibold text-slate-700 mb-1">Tools (comma separated)</label><input type="text" placeholder="Brush, Roller, Ladder" className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" value={taskTools} onChange={(e) => setTaskTools(e.target.value)} /></div>
                            <div>
                              <label className="block text-sm font-semibold text-slate-700 mb-2">Photos</label>
                              <div className="space-y-3">
                                <div className="flex items-center gap-4">
                                  <button type="button" onClick={() => fileInputRef.current?.click()} disabled={isProcessingImages} className="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg border border-slate-300 transition-colors text-sm font-medium disabled:opacity-50"><ImageIcon size={18} />{isProcessingImages ? 'Processing...' : 'Add Photos'}</button>
                                  <input ref={fileInputRef} type="file" accept="image/*" multiple className="hidden" onChange={handleImageUpload} />
                                  <span className="text-xs text-slate-400">{imagePreviews.length} photos selected</span>
                                </div>
                                {imagePreviews.length > 0 && (
                                  <div className="flex gap-3 overflow-x-auto py-2">
                                    {imagePreviews.map((src, idx) => (
                                      <div key={idx} className="relative flex-shrink-0 h-20 w-20 rounded-lg bg-slate-200 overflow-hidden border border-slate-300 group">
                                        <img src={src} alt={`Preview ${idx}`} className="h-full w-full object-cover" />
                                        <button type="button" onClick={() => removeImagePreview(idx)} className="absolute top-1 right-1 p-1 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-sm"><X size={12} /></button>
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        </div>
                        <div className="mt-6 pt-4 border-t border-slate-100 flex justify-end gap-3">
                          <button type="button" onClick={resetTaskForm} className="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Cancel</button>
                          <button type="submit" disabled={isProcessingImages} className="px-6 py-2 bg-slate-900 text-white rounded-lg font-bold hover:bg-slate-800 transition-colors shadow-sm flex items-center gap-2 disabled:bg-slate-600"><Save size={18} /> Save Entry</button>
                        </div>
                      </form>
                    </div>
                  )}

                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 print:block">
                    <div className="lg:col-span-2 space-y-6 print:space-y-0 print:block">
                      {activeJob.tasks.length === 0 && !isTaskFormOpen ? (
                        <div className="text-center py-20 bg-white rounded-xl border-2 border-dashed border-slate-200 print:border-black">
                          <div className="inline-flex items-center justify-center w-20 h-20 bg-slate-50 rounded-full mb-4 print:hidden"><Clipboard className="text-slate-300" size={40} /></div>
                          <h3 className="text-xl font-bold text-slate-700 print:text-black">Job Log Empty</h3>
                          <p className="text-slate-400 mt-2 print:text-gray-600">No tasks recorded for this address yet.</p>
                        </div>
                      ) : (
                        <div className="grid gap-6 print:block print:gap-0">
                          {activeJob.tasks.map((task, index) => (
                            <div key={task.id} className="print:break-inside-avoid print:mb-8">
                              <TaskCard task={task} index={index} onDelete={deleteTask} />
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                    <div className="lg:col-span-1 print:hidden">
                       <SummarySidebar tasks={activeJob.tasks} jobAddress={activeJob.address} clientName={activeJob.clientName} />
                    </div>
                  </div>
                </>
              )}
            </main>
          </div>
        );
      };

      // --- MOUNT APP ---
      const rootElement = document.getElementById('root');
      if (rootElement) {
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);
      }
    </script>
  </body>
</html>